# ToDo: CI/CD to be seperated into multiple workflows for better maintainability.
name: Spring Boot Microservices CI/CD

on:
  push:
    branches: [ "deploy_to_azure" ]

# Enable GitHub OIDC for secure authentication to Azure
permissions:
  id-token: write
  contents: read

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: dev
    env:
      AZURE_CONTAINER_REGISTRY: ${{ vars.AZURE_CONTAINER_REGISTRY }}

    #  Use JDK 21 for building spring boot microservices.
    #  Use springboot maven plugin with buildpacks to create docker images and push to Azure Container Registry
      #  Use parent pom.xml to build all microservices
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
          enable-oidc: true

      - name: Login to ACR
        run: az acr login --name ${{ vars.AZURE_CONTAINER_REGISTRY_NAME }}

      - name: Give execute permission to mvnw
        run: chmod +x mvnw

      - name: Build and Push Microservice Images to ACR
        run: |
          SERVICES=("api-gateway" "user-service" "order-service" "payment-service" "notification-service" "inventory-service")
          for SERVICE in "${SERVICES[@]}"; do
            if ! git diff --name-only origin/deploy_to_azure...HEAD | grep -q "backend/$SERVICE/"; then
              echo "No changes in $SERVICE, skipping build and push."
              continue
            fi
          echo "Building and pushing $SERVICE..."
          ./mvnw clean spring-boot:build-image -DskipTests -pl backend/$SERVICE -Dspring-boot.build-image.imageName=$AZURE_CONTAINER_REGISTRY/$SERVICE:latest
          docker push $AZURE_CONTAINER_REGISTRY/$SERVICE:latest
          done

      - name: Verify Images in ACR
        run: |
          docker pull $AZURE_CONTAINER_REGISTRY/api-gateway:latest
          docker pull $AZURE_CONTAINER_REGISTRY/user-service:latest
          docker pull $AZURE_CONTAINER_REGISTRY/order-service:latest
          docker pull $AZURE_CONTAINER_REGISTRY/payment-service:latest
          docker pull $AZURE_CONTAINER_REGISTRY/notification-service:latest
          docker pull $AZURE_CONTAINER_REGISTRY/inventory-service:latest

      - name: Deploy to Development Environment (Azure Container Apps)
        run: |
          echo "Deploying microservices to Development Environment..."
          SERVICES=("api-gateway-app" "user-service-app" "order-service-app" "payment-service-app" "notification-service-app" "inventory-service-app")
          for SERVICE in "${SERVICES[@]}"; do
            if ! git diff --name-only origin/deploy_to_azure...HEAD | grep -q "backend/${SERVICE%-app}/"; then
              echo "No changes in ${SERVICE%-app}, skipping deployment."
              continue
            fi
            echo "Deploying $SERVICE to Azure Container Apps..."
            az containerapp update --name $SERVICE --resource-group ${{ vars.RESOURCE_GROUP }} --image $AZURE_CONTAINER_REGISTRY/$SERVICE:latest
          done
          
